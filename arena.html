<!DOCTYPE html>
<html lang="en">

  <head>
    <title>Arena Screen</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <style type="text/css">
      * {
        margin: 0px;
        padding: 0px;
      }

      body {
        font-family: sans-serif;
      }

      section.view {
        position: fixed;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        color: rgb(255, 255, 255);
        background: rgb(0, 0, 0);
      }

      section.corners {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
      }

      section.corners > main {
        flex: 1 0 auto;
      }

      section.corners > aside {
        border-top: 1px solid rgb(0, 0, 0);
        flex: 0 0 auto;
        height: 25%;
        display: flex;
      }

      section.big {
        display: flex;
        justify-content: center;
        align-items: center;
      }

      section.big > main {
        flex: 0 0 auto;
      }

      section.big h1 {
        font-size: 36vw;
      }

      .corner {
        width: 100%;
        height: 100%;
        background: rgb(0, 0, 0);
        display: flex;
        align-items: stretch;
      }

      [hidden] {
        display: none !important;
      }

      .corner aside {
        background: rgb(255, 255, 255);
        flex: 0 0 auto;
        align-self: stretch;
        width: 15%;
      }

      .corner main {
        flex: 1 1 auto;
        text-align: center;
        color: rgb(255, 255, 255);
        display: flex;
        flex-direction: column;
        align-items: stretch;
        justify-content: space-around;
      }

      .corner.small main {
        justify-content: center;
      }

      .corner h1 {
        flex: 0 0 auto;
        font-size: 22vw;
        line-height: 0.8;
      }

      .corner h1.small {
        font-size: 19vw;
      }

      .corner.small h1 {
        font-size: 6vw;
      }

      .corner h2 {
        flex: 0 0 auto;
        font-size: 4vw;
        font-weight: bold;
        margin: 6px;
      }

      .corner p {
        flex: 0 0 auto;
        font-size: 6vw;
        font-weight: bold;
        margin: 5px;
      }
    </style>
  </head>

  <body>
    <script>
      (function() {
        "use strict";

        var pad = function(value) {
          var num = parseInt(value, 10);
          return num < 10 ? "0" + num : num.toString();
        };

        var formatTimeLeft = function(delta) {
          var prefix = "";
          if (delta < 0) {
            delta = -delta;
            prefix = "Starting in ";
          }

          var minutesLeft = parseInt(delta/60, 10);
          var secondsLeft = delta - parseInt(delta/60, 10) * 60;
          return prefix + minutesLeft + ":" + pad(secondsLeft);
        };

        var updateElementIfNecessary = function(element, textContent, className) {
          if (element) {
            if (element.textContent !== textContent) {
              element.textContent = textContent;
            }

            if (className !== undefined) {
              if (element.className !== className) {
                element.className = className;
              }
            }
          }
        };

        var Corner = window.Corner = function(colour, small) {
          this.element = document.createElement("div");
          this.element.classList.add("corner");
          if (small) {
            this.element.classList.add("small");
          }

          var sidebar = document.createElement("aside");
          sidebar.style.backgroundColor = colour;
          this.element.appendChild(sidebar);

          var main = document.createElement("main");

          if (!small) {
            this.matchNumberElement = document.createElement("h2");
            main.appendChild(this.matchNumberElement);
          }

          this.teamElement = document.createElement("h1");
          main.appendChild(this.teamElement);

          if (!small) {
            this.timeLeftElement = document.createElement("p");
            main.appendChild(this.timeLeftElement);
          }

          this.element.appendChild(main);

          this.element.appendChild(sidebar.cloneNode(false));
        };

        Corner.prototype.update = function(team, matchNumber, delay) {
          updateElementIfNecessary(this.matchNumberElement, "Match " + matchNumber);
          updateElementIfNecessary(this.timeLeftElement, formatTimeLeft(delay));

          if (team) {
            updateElementIfNecessary(this.teamElement, team, team.length === 4 ? "small" : "");
          }
        };
      }());
    </script>

    <script>
      (function() {
        var CornersView = window.CornersView = function(cornerDefs, mainCorner) {
          var main = document.createElement("main");
          var aside = document.createElement("aside");

          this.corners = [];
          cornerDefs.forEach(function(cornerDef, i) {
            var small = i !== mainCorner;
            var corner = new Corner(cornerDef.colour, small);
            if (small) {
              aside.appendChild(corner.element);
            } else {
              main.appendChild(corner.element);
            }

            this.corners.push(corner);
          }.bind(this));

          this.element = document.createElement("section");
          this.element.classList.add("view");
          this.element.classList.add("corners");
          this.element.appendChild(main);
          this.element.appendChild(aside);
        };

        CornersView.prototype.update = function(currentMatch, nextMatch) {
          this.corners.forEach(function(corner, i) {
            if (!currentMatch && !nextMatch) {
              // TODO: implement
            } else {
              var timeToStart = nextMatch.secondsToStart();
              if (timeToStart <= 120 || !currentMatch) {
                corner.update(nextMatch.teams[i], nextMatch.number,
                              -timeToStart);
              } else {
                var timeToEnd = currentMatch.secondsToEnd() - 120;
                corner.update(currentMatch.teams[i], currentMatch.number,
                              timeToEnd);
              }
            }
          });
        };
      }());
    </script>

    <script>
      (function() {
        var BigView = window.BigView = function() {
          var main = document.createElement("main");
          this.h1 = document.createElement("h1");
          main.appendChild(this.h1);

          this.element = document.createElement("section");
          this.element.classList.add("view");
          this.element.classList.add("big");
          this.element.appendChild(main);
        };

        BigView.prototype.update = function(text) {
          if (this.h1.textContent !== text) {
            this.h1.textContent = text;
          }
        };
      }());
    </script>

    <script>
      (function() {
        "use strict";

        // you might want to set this to '' this in development.
        var API_ROOT = '/comp-api';

        var Corner = function(def) {
          this.colour = def.colour;
        };

        var Match = function(def) {
          this.teams = def.teams;
          this.number = this.id = def.number;
          this.startTime = new Date(def.start_time);
          this.endTime = new Date(def.end_time);
        };

        Match.prototype.secondsToStart = function() {
          return parseInt((this.startTime - new Date()) / 1000);
        };

        Match.prototype.secondsToEnd = function() {
          return parseInt((this.endTime - new Date()) / 1000);
        };

        var Resources = window.Resources = function() {

        };

        Resources.prototype.get = function(url, resource, callback) {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", API_ROOT + url);
          xhr.responseType = "json";
          xhr.addEventListener("load", function(e) {
            var res = new resource(e.target.response);
            callback(res);
          });
          xhr.send();
        };

        Resources.prototype.getArenas = function(callback) {
          this.get("/arenas", Object, callback);
        };

        Resources.prototype.getMatches = function(query, callback) {
          this.get("/matches/" + query, Object, callback);
        };

        Resources.prototype.getCorner = function(id, callback) {
          this.get("/corner/" + id, Corner, callback);
        };

        Resources.prototype.getCurrentAndNextMatch = function(arena, callback) {
          this.getMatches(arena + "?numbers=current,next", function(res) {
            var m = res.matches;
            var m0 = m[0].error ? null : new Match(m[0]);
            var m1 = m[1].error ? null : new Match(m[1]);
            callback(m0, m1);
          });
        };

        Resources.prototype.getAllCorners = function(callback) {
          this.getCorner(0, function(corner0) {
            this.getCorner(1, function(corner1) {
              this.getCorner(2, function(corner2) {
                this.getCorner(3, function(corner3) {
                  callback([corner0, corner1, corner2, corner3]);
                }.bind(this));
              }.bind(this));
            }.bind(this));
          }.bind(this));
        };
      }());
    </script>

    <script>
      // work around slightly older Firefox (<23) not having requestAnimationFrame.
      window.requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame;
      (function() {
        var resources = new Resources();
        var badCorner = function(cornerDefs) {
          var buttonsDiv = document.createElement("div");
          var showButtons = function(cornerDefs) {
            resources.getArenas(function(arenas) {
              arenas = arenas.arenas;
              for (var i = 0; i < arenas.length; i++) {
                var arena = arenas[i];
                var para = document.createElement("p");
                for (var c = 0; c < cornerDefs.length; c++) {
                  var link = document.createElement("a");
                  link.href = "?arena=" + arena + "&corner=" + c;
                  link.textContent = arena + ":" + c;
                  link.style = "padding: 0.5em; margin: 0.5em; font-size: 1.2em;";
                  para.appendChild(link);
                }
                buttonsDiv.appendChild(para);
              }
            });
          };
          if (cornerDefs != null) {
            showButtons(cornerDefs);
          } else {
            resources.getAllCorners(showButtons);
          }
          var h2 = document.createElement("h2");
          h2.textContent = "Invalid arena corner specified";
          document.body.appendChild(h2);
          var h3 = document.createElement("h3");
          h3.textContent = "Please choose a suitable corner:";
          document.body.appendChild(h3);
          document.body.appendChild(buttonsDiv);
        };

        // load which arena corner were are from url parameters.
        var pairs = window.location.search.substr(1).split("&");
        var args = {};
        for (var i = 0; i < pairs.length; i++) {
          var bits = pairs[i].split("=");
          args[bits[0]] = bits[1];
        }
        var arenaId = args["arena"];
        var cornerId = parseInt(args["corner"], 10);

        if (arenaId == null || arenaId.length === 0 || isNaN(cornerId)) {
          badCorner();
          return;
        }

        var loadCorners = function(resources, mainCorner, callback) {
          resources.getAllCorners(function(cornerDefs) {
            if (mainCorner > cornerDefs.length) {
              badCorner(cornerDefs);
              return;
            }
            var corners = new CornersView(cornerDefs, mainCorner);
            document.body.appendChild(corners.element);
            callback(corners);
          });
        };

        loadCorners(resources, cornerId, function(corners) {
          var countdownView = new BigView();
          countdownView.element.hidden = true; // start hidden
          document.body.appendChild(countdownView.element);

          countdownView.update("5");

          var currentMatch = undefined;
          var nextMatch = undefined;

          // timer to update the match data at regular intervals
          var updateModel = function() {
            resources.getCurrentAndNextMatch(arenaId, function(current, next) {
              if (currentMatch === undefined) {
                window.requestAnimationFrame(updateView);
              }

              currentMatch = current;
              nextMatch = next;
            });
          };
          setInterval(updateModel, 1000);
          updateModel();

          // timer to redraw the UI faster than the data is updated
          var updateView = function() {
            var timeToStart = nextMatch.secondsToStart();
            if (timeToStart <= 5 && timeToStart > 0) {
              if (countdownView.element.hidden) {
                countdownView.element.hidden = false;
              }
              countdownView.update(timeToStart);
            } else {
              if (!countdownView.element.hidden) {
                countdownView.element.hidden = true;
              }
            }

            corners.update(currentMatch, nextMatch);
            window.requestAnimationFrame(updateView);
          };

        });
      }());
    </script>
  </body>

</html>
