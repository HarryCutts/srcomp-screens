<!DOCTYPE html>
<html lang="en" ng-app="app">

  <head>
    <title>Arena Screen</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <style type="text/css">
      * {
        margin: 0px;
        padding: 0px;
      }

      html, body {
        width: 100%;
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-items: stretch;
      }

      body > main {
        flex: 1 0 auto;
      }

      body > aside {
        border-top: 1px solid rgb(255, 255, 255);
        flex: 0 0 auto;
        height: 25%;
        display: flex;
      }

      section.corner {
        width: 100%;
        height: 100%;
        background: rgb(0, 0, 0);
        display: flex;
        align-items: stretch;
        font-family: sans-serif;
      }

      section.corner aside {
        background: rgb(255, 255, 255);
        flex: 0 0 auto;
        align-self: stretch;
        width: 15%;
      }

      section.corner main {
        flex: 1 1 auto;
        align-self: center;
        text-align: center;
        color: rgb(255, 255, 255)
      }

      section.corner h1 {
        font-size: 22vw;
      }

      section.corner h1.small {
        font-size: 16vw;
      }

      section.corner.small h1 {
        font-size: 6vw;
      }

      section.corner h2 {
        font-size: 4vw;
        font-weight: bold;
        margin: 6px;
      }

      section.corner p {
        font-size: 6vw;
        font-weight: bold;
        margin: 5px;
      }
    </style>
  </head>

  <body>
    <main>
    <!-- main corner goes here -->
    </main>

    <aside>
    <!-- other corners go in here -->
    </aside>

    <script>
      (function() {
        "use strict";

        var pad = function(s) {
          if (parseInt(s) < 10) {
            return "0" + s;
          } else {
            return s;
          }
        };

        var formatTimeLeft = function(delta) {
          var prefix = "";
          if (delta < 0) {
            delta = -delta;
            prefix = "Starting in ";
          }

          var minutesLeft = parseInt(delta/60, 10);
          var secondsLeft = delta - parseInt(delta/60, 10) * 60;
          return prefix + minutesLeft + ":" + pad(secondsLeft);
        };

        var updateElementIfNecessary = function(element, textContent) {
          if (element) {
            if (element.textContent !== textContent) {
              element.textContent = textContent;
            }
          }
        };

        var Corner = window.Corner = function(colour, small) {
          this.element = document.createElement("section");
          this.element.classList.add("corner");
          if (small) {
            this.element.classList.add("small");
          }

          var sidebar = document.createElement("aside");
          sidebar.style.backgroundColor = colour;
          this.element.appendChild(sidebar);

          var main = document.createElement("main");

          if (!small) {
            this.matchNumberElement = document.createElement("h2");
            main.appendChild(this.matchNumberElement);
          }

          this.teamElement = document.createElement("h1");
          main.appendChild(this.teamElement);

          if (!small) {
            this.timeLeftElement = document.createElement("p");
            main.appendChild(this.timeLeftElement);
          }

          this.element.appendChild(main);

          this.element.appendChild(sidebar.cloneNode(false));
        };

        Corner.prototype.update = function(team, matchNumber, delay) {
          updateElementIfNecessary(this.matchNumberElement, "Match " + matchNumber);
          updateElementIfNecessary(this.teamElement, team);
          updateElementIfNecessary(this.timeLeftElement, formatTimeLeft(delay));
        };
      }());
    </script>

    <script>
      (function() {
        "use strict";

        var Resources = window.Resources = function() {

        };

        Resources.prototype.get = function(url, callback) {
          var xhr = new XMLHttpRequest();
          xhr.open("GET", url);
          xhr.responseType = "json";
          xhr.addEventListener("load", function(e) {
            callback(e.target.response);
          });
          xhr.send();
        };

        Resources.prototype.getMatches = function(arena, query, callback) {
          this.get("/matches/" + arena + "/" + query, callback);
        };

        Resources.prototype.getCorner = function(id, callback) {
          this.get("/corner/" + id, callback);
        };

        Resources.prototype.getCurrentAndNextMatch = function(arena, callback) {
          this.getMatches(arena, "current", function(currentMatch) {
            this.getMatches(arena, currentMatch.number + 1, function(nextMatch) {
              callback(currentMatch, nextMatch);
            }.bind(this));
          }.bind(this));
        };

        Resources.prototype.getAllCorners = function(callback) {
          this.getCorner(0, function(corner0) {
            this.getCorner(1, function(corner1) {
              this.getCorner(2, function(corner2) {
                this.getCorner(3, function(corner3) {
                  callback([corner0, corner1, corner2, corner3]);
                }.bind(this));
              }.bind(this));
            }.bind(this));
          }.bind(this));
        };
      }());
    </script>

    <script>
      (function() {
        var fragment = window.location.hash.substr(1).split(",");
        var arenaId = fragment[0];
        var cornerId = parseInt(fragment[1]);

        var loadCorners = function(resources, mainCorner, callback) {
          var main = document.querySelector("main");
          var aside = document.querySelector("aside");
          var corners = [];

          resources.getAllCorners(function(cornerDefs) {
            cornerDefs.forEach(function(cornerDef, i) {
              var small = i !== mainCorner;
              var corner = new Corner(cornerDef.colour, small);
              if (small) {
                aside.appendChild(corner.element);
              } else {
                main.appendChild(corner.element);
              }

              corners.push(corner);
            });

            callback(corners);
          });
        };

        var resources = new Resources();
        loadCorners(resources, cornerId, function(corners) {
          var currentMatch = undefined;
          var nextMatch = undefined;

          // timer to update the match data at regular intervals
          setInterval(function() {
            resources.getCurrentAndNextMatch(arenaId, function(current, next) {
              if (currentMatch === undefined) {
                // start redrawing the UI once we are sure a match exists
                window.requestAnimationFrame(updateView);
              }

              currentMatch = current;
              nextMatch = next;
            });
          }, 1000);

          // timer to redraw the UI faster than the data is updated
          var updateView = function() {
            corners.forEach(function(corner, i) {
              if (!currentMatch && !nextMatch) {
                // TODO: implement
              } else {
                var timeToStart = parseInt((new Date(nextMatch.start_time) - new Date()) / 1000);
                if (timeToStart <= 120 || !currentMatch) {
                  corner.update(nextMatch.teams[i], nextMatch.number,
                                -timeToStart);
                } else {
                  var timeToEnd = parseInt((new Date(currentMatch.end_time) - new Date()) / 1000) - 120;
                  corner.update(currentMatch.teams[i], currentMatch.number,
                                timeToEnd);
                }
              }
            });

            window.requestAnimationFrame(updateView);
          };
        });
      }());
    </script>
  </body>

</html>
