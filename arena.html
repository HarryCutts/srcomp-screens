<!DOCTYPE html>
<html lang="en" ng-app="app">

  <head>
    <title>Arena Screen</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.1/angular.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.1/angular-resource.js"></script>

    <script>
      var get = function(url, callback) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", url, true);
        xhr.responseType = "json";
        xhr.addEventListener("load", function(e) {
          callback(e.target.response);
        });
        xhr.send();
      };

      var getMatch = function(id, callback) {
        var url = "/matches/" + id + "/current";
        get(url, callback);
      };

      var getCorner = function(id, callback) {
        var url = "/corner/" + id;
        get(url, callback);
      };

      var app = angular.module("app", ["ngResource"], function($locationProvider) {
        $locationProvider.html5Mode(true);
      });

      var pad = function(s) {
        if (parseInt(s) < 10) {
          return "0" + s;
        } else {
          return s;
        }
      }

      app.filter("formatTimeLeft", function() {
        return function(input) {
          var delta = parseInt((new Date(input) - new Date()) / 1000, 10);

          var minutesLeft = parseInt(delta/60, 10);
          var secondsLeft = delta - parseInt(delta/60, 10) * 60;
          return minutesLeft + ":" + pad(secondsLeft);
        };
      });

      app.controller("MainController", function($scope, $resource, $location, $interval, $filter) {
        var arena = $location.search().arena;
        var corner = $scope.corner = parseInt($location.search().corner, 10);

        getCorner(0, function(corner0) {
          getCorner(1, function(corner1) {
            getCorner(2, function(corner2) {
              getCorner(3, function(corner3) {
                $scope.corners = [corner0, corner1, corner2, corner3];
              });
            });
          });
        });

        var otherCorners = $scope.otherCorners = [0, 1, 2, 3];
        otherCorners.splice(corner, 1);

        var currentMatch = undefined;
        $interval(function() {
          getMatch(arena, function(match) {
            currentMatch = match;
          });
        }, 1000);

        $interval(function() {
          $scope.match = currentMatch;
        }, 500);

        var time = document.getElementById("time");
        var updateView = function() {
          if (currentMatch) {
            time.textContent = $filter("formatTimeLeft")(currentMatch.end_time);
          }
          window.requestAnimationFrame(updateView);
        };

        updateView();
      });
    </script>

    <style type="text/css">
      * {
        margin: 0px;
        padding: 0px;
      }

      html, body {
        width: 100%;
        height: 100%;
      }

      body {
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        align-content: stretch;
        align-items: stretch;
      }

      main {
        flex: 1 0 auto;
      }

      aside {
        border-top: 1px solid rgb(255, 255, 255);
        flex: 0 0 auto;
        height: 25%;
        display: flex;
      }

      section.match {
        width: 100%;
        height: 100%;
        background: rgb(0, 0, 0);
        display: flex;
        align-items: stretch;
        font-family: sans-serif;
      }

      section.match > div:nth-child(1), section.match > div:nth-child(3) {
        background: rgb(255, 255, 255);
        flex: 0 0 auto;
        align-self: stretch;
        width: 15%;
      }

      section.match > div:nth-child(2) {
        flex: 1 1 auto;
        align-self: center;
        text-align: center;
        color: rgb(255, 255, 255)
      }

      section.match.big h1 {
        font-size: 24vw;
      }

      section.match.big h1.small {
        font-size: 18vw;
      }

      section.match.small h1 {
        font-size: 6vw;
      }

      section.match p {
        font-size: 6vw;
        font-weight: bold;
        margin: 5px;
      }
    </style>
  </head>

  <body ng-controller="MainController">
    <main>
      <section class="match big">
        <div ng-style="{background: corners[corner].colour}"></div>
        <div>
          <p>Match {{ match.number }}</p>
          <h1>{{ match.teams[corner] }}</h1>
          <p id="time"></p>
        </div>
        <div ng-style="{background: corners[corner].colour}"></div>
      </section>
    </main>

    <aside>
      <section class="match small" ng-repeat="i in [0,1,2]">
        <div ng-style="{background: corners[otherCorners[i]].colour}"></div>
        <div>
          <h1>{{ match.teams[otherCorners[i]] }}</h1>
        </div>
        <div ng-style="{background: corners[otherCorners[i]].colour}"></div>
      </section>
    </aside>
  </body>

</html>
