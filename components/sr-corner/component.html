<link rel="import" href="../../bower_components/polymer/polymer.html" />

<link rel="import" href="../sr-corner-clock/component.html" />
<link rel="import" href="../sr-corner-match/component.html" />
<link rel="import" href="../sr-corner-team/component.html" />

<polymer-element name="sr-corner" attributes="arena corner stream show">
    <template>
        <style>
            :host {
                display: flex;
                flex-direction: row;
            }

            .bar {
                flex: 0 0 auto;
                width: 15%;
                background: {{ colour }};
            }

            main {
                flex: 1 1 auto;
                background: black;
                background-repeat: no-repeat;
                background-size: cover;
                background-position: center;

                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
        </style>

        <aside class="bar"></aside>

        <main id="main">
            <template if="{{ show == 'all' }}">
                <sr-corner-match id="match"></sr-corner-match>
                <sr-corner-team id="team" corner="{{ corner }}" show="all"></sr-corner-team>
                <sr-corner-clock id="clock"></sr-corner-clock>
            </template>

            <template if="{{ show == 'tla' }}">
                <sr-corner-team id="team" corner="{{ corner }}" show="tla"></sr-corner-team>
            </template>
        </main>

        <aside class="bar"></aside>
    </template>

    <script>
        var reload = function() {
            if (this.comp == null || this.corner == null || this.arena == null) {
                return;
            }

            this.comp.api.getCorner(this.corner, function(corner) {
                this.colour = corner.colour;
            }.bind(this));

            this.$.team.comp = this.comp;

            this.comp.stream.addEventListener('match', function(e) {
                var matches = e.detail.filter(function(match) {
                    return match.arena === this.arena;
                }.bind(this));

                if (matches.length) {
                    this.match = matches[0];
                } else {
                    this.match = null;

                    this.comp.api.getUpcomingMatches(function(matches) {
                        // only update if we haven't since updated the match
                        if (this.match == null && matches.length) {
                            this.match = matches[0];
                        }
                    }.bind(this));
                }
            }.bind(this));
        };
        Polymer({
            comp: null,
            compChanged: reload,
            arenaChanged: reload,
            cornerChanged: reload,
            match: undefined,
            matchChanged: function() {
                if (this.$.match) {
                    this.$.match.match = this.match;
                }

                this.$.team.match = this.match;

                if (this.$.clock) {
                    this.$.clock.match = this.match;
                }

                if (this.match) {
                    var tla = this.match.teams[this.corner];
                    this.comp.api.getTeam(tla, function(team) {
                        if (team.image_url) {
                            this.$.main.style.backgroundImage = 'linear-gradient(rgba(0, 0, 0, 0.8), rgba(0, 0, 0, 0.8)), url(' + team.image_url + ')';
                        } else {
                            this.$.main.style.backgroundImage = null;
                        }
                    }.bind(this));
                } else {
                    this.$.main.style.backgroundImage = null;
                }
            }
        });
    </script>
</polymer-element>
